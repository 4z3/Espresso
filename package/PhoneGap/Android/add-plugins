#! /bin/sh
set -xeuf

plugins="$(json-print $file package $target plugins | plugins2args)"
echo "$plugins" | while read name value; do

  # copy plugin files
  for i in src libs assets; do
    if test -d app/plugins/$name/$i; then
      tar -C app/plugins/$name -c $i | tar -C android-project -x -v
    fi
  done

  # link js to html
  gsedi android-project/assets/index.html "s:</head>:$(
    find app/plugins/$name/assets -name '*.js' | sed '
        s:^app/plugins/'"$name"'/assets/\(.*\):<script type="application/javascript" src="\1"></script>:
    ')\n&:"

  # add element to res/xml/plugins.xml
  echo "    <plugin name=\""$name"\" value=\""$value"\" />" \
      >> android-project/res/xml/plugins.xml
done

####
echo '
<activity android:name=".CaptureActivity"
              android:screenOrientation="landscape"
              android:configChanges="orientation|keyboardHidden"
              android:theme="@android:style/Theme.NoTitleBar.Fullscreen"
              android:windowSoftInputMode="stateAlwaysHidden">
      <intent-filter>
        <action android:name="android.intent.action.MAIN"/>
        <category android:name="android.intent.category.LAUNCHER"/>
      </intent-filter>
      <intent-filter>
        <action android:name="com.google.zxing.client.android.SCAN"/>
        <category android:name="android.intent.category.DEFAULT"/>
      </intent-filter>
      <!-- Allow web apps to launch Barcode Scanner by linking to http://zxing.appspot.com/scan. -->
      <intent-filter>
        <action android:name="android.intent.action.VIEW"/>
        <category android:name="android.intent.category.DEFAULT"/>
        <category android:name="android.intent.category.BROWSABLE"/>
        <data android:scheme="http" android:host="zxing.appspot.com" android:path="/scan"/>
      </intent-filter>
      <!-- We also support a Google Product Search URL. -->
      <intent-filter>
        <action android:name="android.intent.action.VIEW"/>
        <category android:name="android.intent.category.DEFAULT"/>
        <category android:name="android.intent.category.BROWSABLE"/>
        <data android:scheme="http" android:host="www.google.com" android:path="/m/products/scan"/>
      </intent-filter>
      <!-- And the UK version. -->
      <intent-filter>
        <action android:name="android.intent.action.VIEW"/>
        <category android:name="android.intent.category.DEFAULT"/>
        <category android:name="android.intent.category.BROWSABLE"/>
        <data android:scheme="http" android:host="www.google.co.uk" android:path="/m/products/scan"/>
      </intent-filter>
    </activity>
    <activity android:name=".PreferencesActivity"
              android:label="@string/preferences_name">
    </activity>
    <activity android:name=".encode.EncodeActivity" android:label="@string/share_name">
      <intent-filter>
        <action android:name="com.google.zxing.client.android.ENCODE"/>
        <category android:name="android.intent.category.DEFAULT"/>
      </intent-filter>
      <!-- This allows us to handle the Share button in Contacts. -->
      <intent-filter>
        <action android:name="android.intent.action.SEND"/>
        <category android:name="android.intent.category.DEFAULT"/>
        <data android:mimeType="text/x-vcard"/>
      </intent-filter>
      <!-- This allows us to handle sharing any plain text . -->
      <intent-filter>
        <action android:name="android.intent.action.SEND"/>
        <category android:name="android.intent.category.DEFAULT"/>
        <data android:mimeType="text/plain"/>
      </intent-filter>
    </activity>
    <activity android:name=".book.SearchBookContentsActivity"
              android:label="@string/sbc_name"
              android:screenOrientation="landscape"
              android:configChanges="orientation|keyboardHidden">
      <intent-filter>
        <action android:name="com.google.zxing.client.android.SEARCH_BOOK_CONTENTS"/>
        <category android:name="android.intent.category.DEFAULT"/>
      </intent-filter>
    </activity>
    <activity android:name=".wifi.WifiActivity"
              android:label="@string/wa_name"
              android:screenOrientation="landscape"
              android:configChanges="orientation|keyboardHidden">
    </activity>
    <activity android:name=".share.ShareActivity"
              android:label="@string/share_name"
              android:screenOrientation="user"
              android:theme="@android:style/Theme.Light">
      <intent-filter>
        <action android:name="com.google.zxing.client.android.SHARE"/>
        <category android:name="android.intent.category.DEFAULT"/>
      </intent-filter>
    </activity>
    <activity android:name=".share.BookmarkPickerActivity"
              android:label="@string/bookmark_picker_name">
      <intent-filter>
        <action android:name="android.intent.action.PICK"/>
        <category android:name="android.intent.category.DEFAULT"/>
      </intent-filter>
    </activity>
    <activity android:name=".share.AppPickerActivity"
              android:label="@string/app_picker_name"
              android:configChanges="orientation">
      <intent-filter>
        <action android:name="android.intent.action.PICK"/>
        <category android:name="android.intent.category.DEFAULT"/>
      </intent-filter>
    </activity>
    <activity android:name=".HelpActivity"
              android:screenOrientation="user">
      <intent-filter>
        <action android:name="android.intent.action.VIEW"/>
        <category android:name="android.intent.category.DEFAULT"/>
      </intent-filter>
    </activity>
  <activity android:name="com.google.zxing.client.android.CaptureActivity"
            android:screenOrientation="landscape"
            android:configChanges="orientation|keyboardHidden"
            android:theme="@android:style/Theme.NoTitleBar.Fullscreen"
            android:windowSoftInputMode="stateAlwaysHidden">
    <intent-filter>
      <action android:name="com.phonegap.plugins.barcodescanner.SCAN"/>
      <category android:name="android.intent.category.DEFAULT"/>
    </intent-filter>
  </activity>
  <activity android:name="com.google.zxing.client.android.encode.EncodeActivity" android:label="@string/share_name">
    <intent-filter>
      <action android:name="com.phonegap.plugins.barcodescanner.ENCODE"/>
      <category android:name="android.intent.category.DEFAULT"/>
    </intent-filter>
  </activity>' |
xml-append android-project/AndroidManifest.xml application -

cat android-project/AndroidManifest.xml >&2
###

# move closing tag to the end
gsedi android-project/res/xml/plugins.xml 's:</plugins>::'
echo '</plugins>' \
    >>android-project/res/xml/plugins.xml
